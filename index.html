<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gifts Forge ‚Äî Demo</title>
  <meta name="description" content="Gifts Forge ‚Äî –¥–µ–º–æ –∫—É–∑–Ω–∏—Ü—ã –ø–æ–¥–∞—Ä–∫–æ–≤ (–ª–æ–∫–∞–ª—å–Ω–æ, –±–µ–∑ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π)" />
  <style>
    /* ==========================
       –°—Ç–∏–ª—å (—Ç—ë–º–Ω–∞—è —Ç–µ–º–∞ + –æ—Ä–∞–Ω–∂–µ–≤—ã–µ –∞–∫—Ü–µ–Ω—Ç—ã)
       ========================== */
    :root{
      --bg: #060606;
      --panel: #0f0f10;
      --card: #171717;
      --accent: #ff7b00;
      --accent-weak: #ff7b0055;
      --muted: #bdbdbd;
      --success: #4caf50;
      --danger: #e53935;
      --glass: rgba(255,255,255,0.02);
    }
    *{box-sizing:border-box;font-family:Inter, "Segoe UI", Roboto, "Helvetica Neue", Arial;}
    body{margin:0;background:linear-gradient(180deg,var(--bg),#070707);color:#fff;min-height:100vh;display:flex;flex-direction:column;}
    header{padding:14px;border-bottom:2px solid var(--accent);background:linear-gradient(90deg,rgba(255,123,0,0.03),transparent);display:flex;align-items:center;justify-content:space-between;}
    header h1{margin:0;font-size:18px;letter-spacing:1px;}
    header .balance{font-size:14px;color:var(--muted);}
    main{flex:1;display:flex;align-items:flex-start;justify-content:center;padding:20px 16px;}
    .container{width:100%;max-width:1100px;display:grid;grid-template-columns:1fr 360px;gap:20px;}

    /* –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å ‚Äî –∫—É–∑–Ω–∏—Ü–∞ */
    .forge-panel{background:linear-gradient(180deg,var(--panel),#121212);padding:18px;border-radius:12px;border:1px solid var(--accent-weak);box-shadow:0 10px 30px rgba(0,0,0,0.6);}
    .panel-title{display:flex;align-items:center;justify-content:space-between;}
    .panel-title h2{margin:0;color:var(--accent);}
    .desc{color:var(--muted);font-size:13px;margin-top:8px;}

    .cards-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:16px;}
    .card{
      background:var(--card);border-radius:10px;height:110px;border:2px dashed var(--accent);display:flex;align-items:center;justify-content:center;cursor:pointer;transition:transform .12s,background .12s;
      padding:8px;text-align:center;font-size:13px;
    }
    .card:hover{transform:translateY(-4px);}
    .card.has{border-style:solid;background:linear-gradient(180deg,#2a2a2a,#1f1f1f);}
    .card .title{font-weight:600;font-size:13px;}
    .card .sub{font-size:12px;color:var(--muted);margin-top:6px;}

    /* Forge controls */
    .forge-controls{display:flex;align-items:center;gap:12px;margin-top:16px;}
    .btn{background:var(--accent);color:#000;padding:10px 16px;border-radius:10px;border:none;cursor:pointer;font-weight:600;box-shadow:0 6px 18px #ff7b0033;}
    .btn:disabled{opacity:0.6;cursor:not-allowed;}
    .small-btn{background:transparent;border:1px solid var(--accent);padding:8px;border-radius:10px;color:var(--accent);cursor:pointer;}

    .result{margin-top:12px;padding:10px;border-radius:8px;background:var(--glass);border:1px solid rgba(255,255,255,0.02);min-height:48px;color:var(--muted);}

    /* –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å ‚Äî –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å –∏ –º–∞–≥–∞–∑–∏–Ω */
    .side-panel{display:flex;flex-direction:column;gap:16px;}
    .card-box{background:linear-gradient(180deg,#0f0f10,#161616);padding:14px;border-radius:12px;border:1px solid var(--accent-weak);}

    .inv-list{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px;max-height:340px;overflow:auto;padding-right:6px;}
    .inv-item{width:100%;display:flex;align-items:center;justify-content:space-between;padding:8px;border-radius:8px;background:#121212;border:1px solid rgba(255,255,255,0.02);font-size:13px;}
    .inv-item .left{display:flex;gap:10px;align-items:center;}
    .badge{padding:6px 8px;border-radius:8px;background:rgba(255,123,0,0.08);color:var(--accent);font-weight:600;}

    /* Shop layout */
    .shop-grid{display:grid;grid-template-columns:1fr;gap:8px;margin-top:8px;}
    .shop-item{display:flex;align-items:center;justify-content:space-between;padding:10px;border-radius:8px;background:#121212;border:1px solid rgba(255,255,255,0.02);}
    .muted-small{font-size:12px;color:var(--muted);}

    /* Modal */
    .modal{position:fixed;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:9999;visibility:hidden;opacity:0;transition:opacity .15s,visibility .15s;}
    .modal.show{visibility:visible;opacity:1;}
    .modal-card{width:94%;max-width:720px;background:#0e0e0e;border-radius:12px;padding:16px;border:1px solid var(--accent-weak);max-height:86vh;overflow:auto;}
    .modal-header{display:flex;justify-content:space-between;align-items:center;}
    .search{width:100%;padding:10px;border-radius:10px;background:#121212;border:1px solid rgba(255,255,255,0.03);color:#fff;margin-top:10px;}
    .modal-list{margin-top:12px;display:flex;flex-direction:column;gap:8px;}
    .modal-row{padding:10px;border-radius:8px;background:#121212;border:1px solid rgba(255,255,255,0.02);display:flex;justify-content:space-between;align-items:center;cursor:pointer;}
    .modal-row:hover{background:linear-gradient(90deg,#222,#1a1a1a);}

    /* forging animation overlay */
    .forge-overlay{position:fixed;left:0;top:0;width:100%;height:100%;display:flex;align-items:center;justify-content:center;z-index:10000;pointer-events:none;opacity:0;transition:opacity .12s;}
    .forge-overlay.show{opacity:1;pointer-events:all;}
    .forge-anim{width:420px;height:220px;border-radius:12px;background:linear-gradient(90deg,#111,#080808);display:flex;flex-direction:column;align-items:center;justify-content:center;border:2px solid var(--accent);box-shadow:0 30px 80px rgba(0,0,0,0.7);}
    .sparks{width:100%;height:40px;position:relative;overflow:hidden;}
    .spark{position:absolute;width:6px;height:6px;background:var(--accent);border-radius:50%;opacity:0;animation:fly 900ms linear infinite;}
    @keyframes fly{
      0%{transform:translateY(40px) scale(.3);opacity:0}
      20%{opacity:1}
      50%{transform:translateY(-30px) scale(1.0);opacity:1}
      100%{transform:translateY(-80px) scale(.2);opacity:0}
    }
    .forge-center{margin-top:6px;text-align:center;}
    .forge-center h3{margin:6px 0;color:var(--accent);}

    /* Footer */
    footer{padding:12px;border-top:1px solid rgba(255,255,255,0.03);text-align:center;color:var(--muted);font-size:13px;}
    /* responsive */
    @media(max-width:980px){
      .container{grid-template-columns:1fr; padding-bottom:60px;}
      .side-panel{order:2;}
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header>
    <h1>üî• Gifts Forge (Demo)</h1>
    <div class="balance">‚≠ê <span id="starBalance">10000</span> &nbsp; ‚Ä¢ &nbsp; –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å: <span id="invCount">0</span></div>
  </header>

  <!-- Main -->
  <main>
    <div class="container">
      <!-- Left: Forge panel -->
      <section class="forge-panel">
        <div class="panel-title">
          <h2>–ö—É–∑–Ω–∏—Ü–∞</h2>
          <div class="muted-small">–í—ã–±–µ—Ä–∏ 2‚Äì6 –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤, –º–∏–Ω–∏–º—É–º –æ–¥–∏–Ω –ø–æ–¥–∞—Ä–æ–∫</div>
        </div>
        <div class="desc">–ö–ª–∏–∫–Ω–∏ –ø–æ –ª—é–±–æ–π –∏–∑ 6 –∫–∞—Ä—Ç–æ—á–µ–∫, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –∏–∑ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è, –¥–æ–±–∞–≤–∏—Ç—å –∑–≤—ë–∑–¥—ã –∏–ª–∏ –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä. –ó–∞—Ç–µ–º –Ω–∞–∂–º–∏ <strong>–ö–æ–≤–∞—Ç—å!</strong></div>

        <!-- 6 cards -->
        <div class="cards-grid" id="cardsGrid" aria-label="components">
          <!-- JS –∑–∞–ø–æ–ª–Ω–∏—Ç —ç—Ç–∏ –∫–∞—Ä—Ç–æ—á–∫–∏ -->
        </div>

        <!-- Controls -->
        <div class="forge-controls">
          <button class="btn" id="forgeBtn">–ö–æ–≤–∞—Ç—å!</button>
          <button class="small-btn" id="clearBtn">–°–±—Ä–æ—Å–∏—Ç—å</button>
          <button class="small-btn" id="autoFillBtn">–ê–≤—Ç–æ-–Ω–∞–ø–æ–ª–Ω–∏—Ç—å (–¥–ª—è —Ç–µ—Å—Ç–∞)</button>
        </div>

        <div class="result" id="forgeResult">–†–µ–∑—É–ª—å—Ç–∞—Ç –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—Å—è –∑–¥–µ—Å—å.</div>
      </section>

      <!-- Right: Inventory + Shop -->
      <aside class="side-panel">
        <div class="card-box">
          <h3 style="margin:0;color:var(--accent)">–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</h3>
          <div class="muted-small" style="margin-top:6px">–ù–∞–∂–º–∏ –Ω–∞ –ø—Ä–µ–¥–º–µ—Ç –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–µ, —á—Ç–æ–±—ã –ø—Ä–æ–¥–∞—Ç—å –µ–≥–æ –∑–∞ –µ–≥–æ —Å—Ç–æ–∏–º–æ—Å—Ç—å (TON ‚Üí ‚≠ê).</div>
          <div class="inv-list" id="inventoryList" style="margin-top:10px"></div>
        </div>

        <div class="card-box">
          <h3 style="margin:0;color:var(--accent)">–ú–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã (–º–∞–≥–∞–∑–∏–Ω)</h3>
          <div class="muted-small" style="margin-top:6px">–í –º–∞–≥–∞–∑–∏–Ω–µ –ø–æ–∫–∞–∑–∞–Ω—ã –¥–æ—Å—Ç—É–ø–Ω—ã–µ –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã. –¶–µ–Ω–∞ ‚Äî –≤ –∑–≤—ë–∑–¥–∞—Ö. –ü–µ—Ä–µ–∑–∞—Ä—è–¥–∫–∞ 48—á (–≤ –¥–µ–º–æ ‚Äî –≤ –ø–∞–º—è—Ç–∏).</div>
          <div class="shop-grid" id="shopGrid"></div>
        </div>
      </aside>
    </div>
  </main>

  <!-- Modal: choose component -->
  <div class="modal" id="modal">
    <div class="modal-card">
      <div class="modal-header">
        <h3>–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç</h3>
        <div>
          <button class="small-btn" id="closeModal">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
      </div>

      <input id="modalSearch" class="search" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é (–∏–Ω–≤–µ–Ω—Ç–∞—Ä—å)..." />
      <div style="display:flex;gap:8px;margin-top:10px;">
        <button class="small-btn" id="tabGifts">–¢–æ–ª—å–∫–æ –ø–æ–¥–∞—Ä–∫–∏</button>
        <button class="small-btn" id="tabModifiers">–ú–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã</button>
        <button class="small-btn" id="tabStars">–î–æ–±–∞–≤–∏—Ç—å –∑–≤—ë–∑–¥—ã</button>
        <div style="flex:1"></div>
        <div class="muted-small">–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å: <span id="modalInvCount">0</span></div>
      </div>

      <div class="modal-list" id="modalList"></div>
    </div>
  </div>

  <!-- Craft animation overlay -->
  <div class="forge-overlay" id="forgeOverlay">
    <div class="forge-anim">
      <div class="sparks" id="sparksContainer"></div>
      <div class="forge-center">
        <h3>–ö–æ–≤–∫–∞...</h3>
        <div class="muted-small" id="forgeAnimText">–ü–ª–∞–≤–∏–º –º–∞—Ç–µ—Ä–∏–∞–ª—ã</div>
      </div>
    </div>
  </div>

  <footer>Gifts Forge ‚Äî demo (–ª–æ–∫–∞–ª—å–Ω–æ). –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ ‚Äî –≤ –±—Ä–∞—É–∑–µ—Ä–µ, –±–µ–∑ —Ä–µ–∞–ª—å–Ω—ã—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π.</footer>

  <script>
  /************************************************************************
   * Gifts Forge ‚Äî Demo
   * –ü–æ–ª–Ω–æ—Å—Ç—å—é –ª–æ–∫–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è (–±–µ–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è).
   *
   * –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:
   * - 6 —Å–ª–æ—Ç–æ–≤ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤.
   * - –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—ã–±–æ—Ä–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ (–ø–æ–∏—Å–∫).
   * - –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–≤—ë–∑–¥ –≤ —Å–ª–æ—Ç (—Å–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è —Å –±–∞–ª–∞–Ω—Å–∞).
   * - –ú–∞–≥–∞–∑–∏–Ω –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–≤ (3 —à—Ç. –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞), —Ü–µ–Ω–∞ 500-1500‚≠ê.
   * - –ü–µ—Ä–µ–∑–∞—Ä—è–¥–∫–∞ –º–∞–≥–∞–∑–∏–Ω–∞ 48 —á–∞—Å–æ–≤ (–≤ –ø–∞–º—è—Ç–∏).
   * - –ö–æ–≤–∫–∞ 2 —Å–µ–∫—É–Ω–¥—ã —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π.
   * - –ë–∞–ª–∞–Ω—Å –∑–≤—ë–∑–¥ —Å—Ç–∞—Ä—Ç 10000.
   * - –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å —Å—Ç–∞—Ä—Ç—É–µ—Ç —Å 10 –ø–æ–¥–∞—Ä–∫–æ–≤.
   * - –ü—Ä–æ–¥–∞–∂–∞ –ø–æ–¥–∞—Ä–∫–æ–≤ (TON ‚Üí stars, 1 TON = 142‚≠ê).
   * - –ü–æ–¥–≥—Ä—É–∑–∫–∞ /gifts/<name>.json –ø—Ä–∏ —Ä–µ–Ω–¥–µ—Ä–µ: –µ—Å–ª–∏ –µ—Å—Ç—å –ø–æ–ª–µ display ‚Äî –ø–æ–∫–∞–∂–µ–º –µ–≥–æ.
   *
   * –ó–∞–º–µ—á–∞–Ω–∏—è:
   * - –î–∞–Ω–Ω—ã–µ –ù–ï —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –º–µ–∂–¥—É –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞–º–∏ (–ø–æ –∂–µ–ª–∞–Ω–∏—é).
   * - –≠—Ç–æ—Ç —Ñ–∞–π–ª ‚Äî –¥–µ–º–æ; –¥–ª—è —Ä–µ–∞–ª—å–Ω—ã—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –Ω—É–∂–Ω–∞ —Å–µ—Ä–≤–µ—Ä–Ω–∞—è –ª–æ–≥–∏–∫–∞ –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å TON/Telegram.
   ************************************************************************/

  // ---------- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è ----------
  const TON_TO_STARS = 142;                 // 1 TON = 142 stars
  const STARTING_STARS = 10000;             // —Å—Ç–∞—Ä—Ç–æ–≤—ã–π –±–∞–ª–∞–Ω—Å
  const FORGE_DURATION_MS = 2000;           // 2 —Å–µ–∫—É–Ω–¥—ã –∫–æ–≤–∫–∏
  const SHOP_COOLDOWN_MS = 48 * 60 * 60 * 1000; // 48 —á–∞—Å–æ–≤ (–≤ –¥–µ–º–æ ‚Äî –≤ –ø–∞–º—è—Ç–∏)
  const SHOP_QTY_PER_MOD = 3;               // 3 —à—Ç—É–∫–∏ –∫–∞–∂–¥–æ–≥–æ –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∞

  // ---------- –°–ø–∏—Å–æ–∫ —Ä–µ–∞–ª—å–Ω—ã—Ö –ø–æ–¥–∞—Ä–∫–æ–≤ (—Å TON —Ü–µ–Ω–∞–º–∏) ----------
  // (–≤–∑—è—Ç–æ –∏–∑ —Ç–≤–æ–µ–≥–æ —Å–ø–∏—Å–∫–∞)
  const giftsList = [
    {name:"Plush Pepe", ton:4930},{name:"Heart Locket", ton:1210},{name:"Durov's Cap", ton:870},
    {name:"Precious Peach", ton:389.5},{name:"Heroic Helmet", ton:255},{name:"Mighty Arm", ton:199.99},
    {name:"Nail Bracelet", ton:124.8},{name:"Astral Shard", ton:119.13},{name:"Artisan Brick", ton:110.24},
    {name:"Mini Oscar", ton:93.19},{name:"Loot Bag", ton:93},{name:"Ion Gem", ton:82.38},{name:"Perfume Bottle", ton:80.62},
    {name:"Magic Potion", ton:73.9},{name:"Gem Signet", ton:66.89},{name:"Scared Cat", ton:57.69},{name:"Bonded Ring", ton:53.97},
    {name:"Westside Sign", ton:53.6},{name:"Genie Lamp", ton:47},{name:"Swiss Watch", ton:40},{name:"Sharp Tongue", ton:39.76},
    {name:"Kissed Frog", ton:31.25},{name:"Electric Skull", ton:30.4},{name:"Signet Ring", ton:27.78},{name:"Neko Helmet", ton:27},
    {name:"Low Rider", ton:26.11},{name:"Vintage Cigar", ton:25},{name:"Toy Bear", ton:24.11},{name:"Voodoo Doll", ton:18.88},
    {name:"Mad Pumpkin", ton:18.27},{name:"Diamond Ring", ton:18},{name:"Eternal Rose", ton:15.17},{name:"Ionic Dryer", ton:11.4},
    {name:"Cupid Charm", ton:11.01},{name:"Love Potion", ton:10.38},{name:"Flying Broom", ton:9.77},{name:"Trapped Heart", ton:8.67},
    {name:"Top Hat", ton:8.57},{name:"Skull Flower", ton:8.48},{name:"Crystal Ball", ton:8.24},{name:"Record Player", ton:8},
    {name:"Sky Stilettos", ton:7.32},{name:"Love Candle", ton:7.15},{name:"Sleigh Bell", ton:6.6},{name:"Snoop Cigar", ton:5.89},
    {name:"Hanging Star", ton:5.3},{name:"Sakura Flower", ton:5.21},{name:"Valentine Box", ton:4.61},{name:"Jolly Chimp", ton:4.51},
    {name:"Evil Eye", ton:4.4},{name:"Berry Box", ton:3.98},{name:"Eternal Candle", ton:3.92},{name:"Snow Mittens", ton:3.9},
    {name:"Spy Agaric", ton:3.88},{name:"Input Key", ton:3.76},{name:"Jelly Bunny", ton:3.75},{name:"Bow Tie", ton:3.6},
    {name:"Bunny Muffin", ton:3.46},{name:"Light Sword", ton:3.3},{name:"Witch Hat", ton:3.14},{name:"Hex Pot", ton:3.07},
    {name:"Lush Bouquet", ton:3.07},{name:"Joyful Bundle", ton:3.07},{name:"Snow Globe", ton:2.89},{name:"Restless Jar", ton:2.72},
    {name:"Santa Hat", ton:2.68},{name:"Easter Egg", ton:2.61},{name:"Star Notepad", ton:2.5},{name:"Moon Pendant", ton:2.5},
    {name:"Jack-in-the-Box", ton:2.4},{name:"Swag Bag", ton:2.4},{name:"Fresh Socks", ton:2.2},{name:"Spiced Wine", ton:2.19},
    {name:"Stellar Rocket", ton:2.18},{name:"Snoop Dogg", ton:2.15},{name:"Cookie Heart", ton:2.12},{name:"Jingle Bells", ton:2.12},
    {name:"Tama Gadget", ton:2.11},{name:"Hypno Lollipop", ton:2.09},{name:"Winter Wreath", ton:2.06},{name:"Party Sparkler", ton:2.06},
    {name:"Ginger Cookie", ton:2.05},{name:"Big Year", ton:2.02},{name:"Jester Hat", ton:2},{name:"Holiday Drink", ton:1.93},
    {name:"Pet Snake", ton:1.93},{name:"Homemade Cake", ton:1.91},{name:"Candy Cane", ton:1.89},{name:"Clover Pin", ton:1.88},
    {name:"Whip Cupcake", ton:1.8},{name:"Xmas Stocking", ton:1.77},{name:"Snake Box", ton:1.72},{name:"Lunar Snake", ton:1.7},
    {name:"Lol Pop", ton:1.67},{name:"B-Day Candle", ton:1.61},{name:"Desk Calendar", ton:1.5}
  ];

  // ---------- –ú–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã: –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Ç–∏–ø—ã ----------
  // –ö–∞–∂–¥—ã–π –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä ‚Äî –æ–±—ä–µ–∫—Ç {id,name,description,applyFn}
  // –í –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Ö—Ä–∞–Ω–∏—Ç—Å—è –∫–∞–∫ {id, type, ...}
  const modifierTypes = [
    {
      id: 'plus10pct',
      name: '+10% –∫ —Ü–µ–Ω–µ',
      description: '–î–æ–±–∞–≤–ª—è–µ—Ç +10% –∫ –∏—Ç–æ–≥–æ–≤–æ–π —Å—Ç–æ–∏–º–æ—Å—Ç–∏ —Å–æ–∑–¥–∞–≤–∞–µ–º–æ–≥–æ –ø–æ–¥–∞—Ä–∫–∞.',
      // apply will be executed in forge process
    },
    {
      id: 'plusminus30',
      name: '¬±30% –∫ —Ü–µ–Ω–µ (—Ä–∞–Ω–¥–æ–º–Ω–æ)',
      description: '–ü—Ä–∏–º–µ–Ω—è–µ—Ç –ª–∏–±–æ +30%, –ª–∏–±–æ -30% –∫ –∏—Ç–æ–≥–æ–≤–æ–π —Å—Ç–æ–∏–º–æ—Å—Ç–∏ (—Ä–∞–Ω–¥–æ–º).'
    },
    {
      id: 'return15pct',
      name: '15% —à–∞–Ω—Å –≤–µ—Ä–Ω—É—Ç—å –æ–¥–∏–Ω –ø–æ–¥–∞—Ä–æ–∫',
      description: '15% —à–∞–Ω—Å –≤–µ—Ä–Ω—É—Ç—å –æ–¥–∏–Ω –∏–∑ –ø–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã—Ö –ø–æ–¥–∞—Ä–∫–æ–≤ –æ–±—Ä–∞—Ç–Ω–æ –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å –ø–æ—Å–ª–µ –∫–æ–≤–∫–∏.'
    },
    {
      id: 'saveModifier',
      name: '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–∞–Ω–¥–æ–º–Ω—ã–π –º–æ–¥ (–∫—Ä–æ–º–µ —Å–µ–±—è)',
      description: '–ü–æ—Å–ª–µ –∫–æ–≤–∫–∏ —Å–ª—É—á–∞–π–Ω—ã–π –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–π –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä (–∫—Ä–æ–º–µ —ç—Ç–æ–≥–æ) –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å.'
    }
  ];

  // ---------- –°–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã (–≤ –ø–∞–º—è—Ç–∏) ----------
  let starBalance = STARTING_STARS;
  // –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å: –º–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤: –ø–æ–¥–∞—Ä–∫–∏ —Å {name, ton, type:'gift'} –∏–ª–∏ –º–æ–¥—ã {type:'mod', modId, name} –∏–ª–∏ stars component {type:'stars', amount}
  let inventory = [];
  // –ó–∞–ø–æ–ª–Ω–∏–º –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å –ø–µ—Ä–≤—ã–º–∏ 10 –ø–æ–¥–∞—Ä–∫–∞–º–∏ –¥–ª—è —Ç–µ—Å—Ç–∞
  inventory = giftsList.slice(0,10).map(g => ({...g, type:'gift'}));

  // –°–ª–æ—Ç—ã (6) –¥–ª—è –∫–æ–≤–∫–∏ ‚Äî null –∏–ª–∏ –æ–±—ä–µ–∫—Ç –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ (–∫–∞–∫ –≤ inventory)
  let slots = [null,null,null,null,null,null];

  // –ú–∞–≥–∞–∑–∏–Ω: –º–∞—Å—Å–∏–≤ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ {modId, price, qty, cooldownExpire} –≥–¥–µ cooldownExpire ‚Äî timestamp (ms) –∫–æ–≥–¥–∞ –º–æ–∂–Ω–æ —Å–Ω–æ–≤–∞ –ø—Ä–æ–¥–∞–≤–∞—Ç—å (–≤ –¥–µ–º–æ ‚Äî –≤ –ø–∞–º—è—Ç–∏)
  let shop = [];

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–∞–≥–∞–∑–∏–Ω–∞ (—Å–æ–∑–¥–∞—ë—Ç 3 —à—Ç. –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞ —Å —Ä–∞–Ω–¥–æ–º–Ω–æ–π —Ü–µ–Ω–æ–π)
  function initShop(){
    shop = [];
    modifierTypes.forEach(mod=>{
      const price = 500 + Math.floor(Math.random()*1001); // 500..1500
      shop.push({modId:mod.id, name:mod.name, description:mod.description, price, qty: SHOP_QTY_PER_MOD, cooldownExpire:0});
    });
  }
  initShop();

  // ---------- DOM —ç–ª–µ–º–µ–Ω—Ç—ã ----------
  const cardsGrid = document.getElementById('cardsGrid');
  const forgeBtn = document.getElementById('forgeBtn');
  const clearBtn = document.getElementById('clearBtn');
  const autoFillBtn = document.getElementById('autoFillBtn');
  const forgeResult = document.getElementById('forgeResult');
  const inventoryList = document.getElementById('inventoryList');
  const starBalanceEl = document.getElementById('starBalance');
  const invCountEl = document.getElementById('invCount');
  const shopGrid = document.getElementById('shopGrid');

  // Modal elements
  const modal = document.getElementById('modal');
  const modalList = document.getElementById('modalList');
  const modalSearch = document.getElementById('modalSearch');
  const closeModalBtn = document.getElementById('closeModal');
  const tabGifts = document.getElementById('tabGifts');
  const tabModifiers = document.getElementById('tabModifiers');
  const tabStars = document.getElementById('tabStars');
  const modalInvCount = document.getElementById('modalInvCount');

  // Forge animation elements
  const forgeOverlay = document.getElementById('forgeOverlay');
  const sparksContainer = document.getElementById('sparksContainer');

  // ---------- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ ----------

  // –û–±–Ω–æ–≤–∏—Ç—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ –∏ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è
  function updateHeader(){
    starBalanceEl.textContent = Math.floor(starBalance).toLocaleString('ru-RU');
    invCountEl.textContent = inventory.length;
  }

  // –ü–æ–ø—ã—Ç–∫–∞ —á—Ç–µ–Ω–∏—è gifts/<name>.json ‚Äî –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ –∏ —Å–æ–¥–µ—Ä–∂–∏—Ç –ø–æ–ª–µ 'display', –≤–µ—Ä–Ω—ë–º –µ–≥–æ, –∏–Ω–∞—á–µ null
  async function tryLoadGiftJson(name){
    try{
      const url = `gifts/${encodeURIComponent(name)}.json`;
      const res = await fetch(url);
      if(!res.ok) return null;
      const json = await res.json();
      // –¥–æ–ø—É—Å—Ç–∏–º, —Ñ–∞–π–ª –∏–º–µ–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É { "display":"üéÅ", "frames": [...], ...}
      if(json && json.display) return json.display;
      return null;
    }catch(e){
      return null;
    }
  }

  // –û—Ç—Ä–∏—Å–æ–≤–∞—Ç—å –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å (—Å–ø–∏—Å–æ–∫ —Å–ø—Ä–∞–≤–∞)
  async function renderInventory(){
    inventoryList.innerHTML = '';
    if(inventory.length === 0){
      inventoryList.innerHTML = '<div class="muted-small">–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å –ø—É—Å—Ç.</div>';
    }
    // –î–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–µ–¥–º–µ—Ç–∞ ‚Äî –∫–Ω–æ–ø–∫–∞ –ø—Ä–æ–¥–∞—Ç—å
    for(let i=0;i<inventory.length;i++){
      const it = inventory[i];
      const row = document.createElement('div');
      row.className = 'inv-item';
      const left = document.createElement('div'); left.className='left';
      const titleBox = document.createElement('div');
      // –ï—Å–ª–∏ —ç—Ç–æ –ø–æ–¥–∞—Ä–æ–∫ ‚Äî –ø–æ–ø—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å display –∏–∑ JSON, –∏–Ω–∞—á–µ –ø–æ–∫–∞–∂–µ–º –∏–º—è
      if(it.type === 'gift'){
        const disp = await tryLoadGiftJson(it.name);
        const title = document.createElement('div'); title.innerHTML = `<div style="font-weight:700">${disp?disp:it.name}</div><div class="muted-small">${it.name}</div>`;
        titleBox.appendChild(title);
        left.appendChild(titleBox);
        const right = document.createElement('div');
        const priceStars = Math.round(it.ton * TON_TO_STARS);
        right.innerHTML = `<div style="text-align:right"><div class="muted-small">–¶–µ–Ω–∞</div><div class="badge">${priceStars}‚≠ê</div></div>`;
        row.appendChild(left); row.appendChild(right);
      } else if(it.type === 'mod'){
        const title = document.createElement('div'); title.innerHTML = `<div style="font-weight:700">${it.name}</div><div class="muted-small">${it.description}</div>`;
        titleBox.appendChild(title);
        left.appendChild(titleBox);
        const right = document.createElement('div'); right.innerHTML = `<div class="muted-small">–ú–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä</div>`;
        row.appendChild(left); row.appendChild(right);
      } else if(it.type === 'stars'){
        const title = document.createElement('div'); title.innerHTML = `<div style="font-weight:700">${it.amount}‚≠ê</div><div class="muted-small">–ó–≤—ë–∑–¥—ã</div>`;
        titleBox.appendChild(title);
        left.appendChild(titleBox);
        const right = document.createElement('div'); right.innerHTML = `<div class="muted-small">–ö–æ–º–ø–æ–Ω–µ–Ω—Ç</div>`;
        row.appendChild(left); row.appendChild(right);
      }

      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ ‚Äî –ø—Ä–æ–¥–∞–∂–∞ –ø–æ–¥–∞—Ä–∫–∞ (–µ—Å–ª–∏ —ç—Ç–æ –ø–æ–¥–∞—Ä–æ–∫)
      row.onclick = () => {
        if(it.type === 'gift'){
          if(!confirm(`–ü—Ä–æ–¥–∞—Ç—å "${it.name}" –∑–∞ ${(it.ton*TON_TO_STARS).toFixed(0)}‚≠ê?`)) return;
          const price = Math.round(it.ton * TON_TO_STARS);
          starBalance += price;
          inventory.splice(i,1);
          renderInventory();
          updateHeader();
        } else {
          alert('–ú–æ–∂–Ω–æ –ø—Ä–æ–¥–∞–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –ø–æ–¥–∞—Ä–∫–∏ (type: gift). –ú–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã –∏ –∑–≤—ë–∑–¥—ã –Ω–µ–ª—å–∑—è –ø—Ä–æ–¥–∞—Ç—å –∑–¥–µ—Å—å.');
        }
      };

      inventoryList.appendChild(row);
    }
    updateHeader();
    modalInvCount.textContent = inventory.length;
  }

  // –û—Ç—Ä–∏—Å–æ–≤–∞—Ç—å —Å–ª–æ—Ç—ã (6 –∫–∞—Ä—Ç–æ—á–µ–∫)
  async function renderSlots(){
    cardsGrid.innerHTML = '';
    for(let i=0;i<6;i++){
      const slot = slots[i];
      const card = document.createElement('div');
      card.className = 'card' + (slot ? ' has' : '');
      // content depends on slot.type
      if(!slot){
        card.innerHTML = '<div style="font-size:26px;color:var(--accent)">+</div>';
      } else {
        if(slot.type === 'gift'){
          const disp = await tryLoadGiftJson(slot.name);
          card.innerHTML = `<div><div class="title">${disp?disp:slot.name}</div><div class="sub">${Math.round(slot.ton*TON_TO_STARS)}‚≠ê</div></div>`;
        } else if(slot.type === 'mod'){
          card.innerHTML = `<div><div class="title">${slot.name}</div><div class="sub">–ú–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä</div></div>`;
        } else if(slot.type === 'stars'){
          card.innerHTML = `<div><div class="title">${slot.amount}‚≠ê</div><div class="sub">–°—Ç—Ä–æ–∫–∞</div></div>`;
        }
      }
      // click ‚Äî open modal to choose
      (function(index){
        card.onclick = () => openModalForSlot(index);
      })(i);
      cardsGrid.appendChild(card);
    }
  }

  // –®–∞–±–ª–æ–Ω —Å–æ–∑–¥–∞–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–∞ –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∞ –¥–ª—è –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è
  function makeModInstance(modId){
    const modType = modifierTypes.find(m=>m.id===modId);
    if(!modType) return null;
    return {type:'mod', modId, name:modType.name, description:modType.description};
  }

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–ª—É—á–∞–π–Ω–æ–≥–æ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è ‚Äî –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
  function autofillSlotsForTest(){
    // –ø–µ—Ä–µ—Ç–∞—â–∏–º –ø–µ—Ä–≤—ã–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –ø–æ–¥–∞—Ä–∫–∏ –≤ —Å–ª–æ—Ç—ã (–µ—Å–ª–∏ –µ—Å—Ç—å)
    for(let i=0;i<6;i++){
      if(inventory.length>0){
        // –≤–æ–∑—å–º—ë–º –∏ —É–¥–∞–ª–∏–º –ø–µ—Ä–≤—ã–π –ø–æ–¥–∞—Ä–æ—á–µ–∫
        slots[i] = inventory.shift();
      } else {
        slots[i] = null;
      }
    }
    renderSlots();
    renderInventory();
  }

  // ---------- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—ã–±–æ—Ä–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ ----------
  let currentSlotIndex = null;
  let currentTab = 'gifts'; // 'gifts', 'modifiers', 'stars'

  function openModalForSlot(slotIndex){
    currentSlotIndex = slotIndex;
    currentTab = 'gifts';
    modal.classList.add('show');
    modal.style.visibility = 'visible';
    modal.style.opacity = '1';
    modalSearch.value = '';
    renderModal();
  }

  function closeModal(){
    modal.classList.remove('show');
    modal.style.visibility = 'hidden';
    modal.style.opacity = '0';
    currentSlotIndex = null;
  }

  closeModalBtn.onclick = closeModal;
  tabGifts.onclick = () => { currentTab='gifts'; renderModal(); };
  tabModifiers.onclick = () => { currentTab='modifiers'; renderModal(); };
  tabStars.onclick = () => { currentTab='stars'; renderModal(); };

  // –†–µ–Ω–¥–µ—Ä –º–æ–¥–∞–ª—å–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤–∫–ª–∞–¥–∫–∏
  async function renderModal(){
    modalList.innerHTML = '';
    modalInvCount.textContent = inventory.length;
    const q = modalSearch.value.trim().toLowerCase();
    if(currentTab === 'gifts'){
      // –ü–æ–∫–∞–∑–∞—Ç—å —Ç–æ–ª—å–∫–æ –ø–æ–¥–∞—Ä–∫–∏
      inventory.forEach((it, idx) => {
        if(it.type !== 'gift') return;
        if(q && !it.name.toLowerCase().includes(q)) return;
        const row = document.createElement('div');
        row.className = 'modal-row';
        // try to get display
        const display = await tryLoadGiftJson(it.name);
        row.innerHTML = `<div><div style="font-weight:700">${display?display:it.name}</div><div class="muted-small">${it.name}</div></div><div class="muted-small">${Math.round(it.ton*TON_TO_STARS)}‚≠ê</div>`;
        row.onclick = () => {
          // take the item from inventory and put to slot
          // find its index in current inventory (might be different)
          const realIdx = inventory.indexOf(it);
          if(realIdx === -1) { alert('–≠–ª–µ–º–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω.'); return; }
          const comp = inventory.splice(realIdx,1)[0];
          // if slot already had something, return it to inventory
          if(slots[currentSlotIndex]) inventory.push(slots[currentSlotIndex]);
          slots[currentSlotIndex] = comp;
          renderSlots();
          renderInventory();
          closeModal();
        };
        modalList.appendChild(row);
      });
      if(modalList.childElementCount===0){
        modalList.innerHTML = '<div class="muted-small">–ù–µ—Ç –ø–æ–¥–∞—Ä–∫–æ–≤ –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–µ –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö –ø–æ–¥ –ø–æ–∏—Å–∫.</div>';
      }
    } else if(currentTab === 'modifiers'){
      // –ü–æ–∫–∞–∑–∞—Ç—å —Ç–æ–ª—å–∫–æ –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã
      inventory.forEach((it, idx) => {
        if(it.type !== 'mod') return;
        if(q && !it.name.toLowerCase().includes(q)) return;
        const row = document.createElement('div');
        row.className = 'modal-row';
        row.innerHTML = `<div><div style="font-weight:700">${it.name}</div><div class="muted-small">${it.description}</div></div><div class="muted-small">–ú–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä</div>`;
        row.onclick = () => {
          const realIdx = inventory.indexOf(it);
          if(realIdx === -1) return;
          const comp = inventory.splice(realIdx,1)[0];
          if(slots[currentSlotIndex]) inventory.push(slots[currentSlotIndex]);
          slots[currentSlotIndex] = comp;
          renderSlots(); renderInventory(); closeModal();
        };
        modalList.appendChild(row);
      });
      if(modalList.childElementCount===0){
        modalList.innerHTML = '<div class="muted-small">–ù–µ—Ç –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–≤ –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–µ.</div>';
      }
    } else if(currentTab === 'stars'){
      // –ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–ª–µ –≤–≤–æ–¥–∞ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–≤—ë–∑–¥ –∫–∞–∫ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
      modalList.innerHTML = '';
      const wrapper = document.createElement('div');
      wrapper.style.display='flex';
      wrapper.style.gap='8px';
      wrapper.style.alignItems='center';
      const input = document.createElement('input');
      input.type='number';
      input.placeholder='–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–≤—ë–∑–¥ (–Ω–∞–ø—Ä. 100)';
      input.className='search';
      input.style.marginTop='6px';
      input.min=1;
      input.max=Math.floor(starBalance);
      const addBtn = document.createElement('button');
      addBtn.className='btn';
      addBtn.style.marginTop='6px';
      addBtn.textContent = '–î–æ–±–∞–≤–∏—Ç—å –∫–∞–∫ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç';
      addBtn.onclick = () => {
        const v = Number(input.value);
        if(!v || v<=0){ alert('–í–≤–µ–¥–∏—Ç–µ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ —á–∏—Å–ª–æ –∑–≤—ë–∑–¥.'); return; }
        if(v > starBalance){ alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∑–≤—ë–∑–¥ –Ω–∞ –±–∞–ª–∞–Ω—Å–µ.'); return; }
        starBalance -= v;
        // —Å–æ–∑–¥–∞—ë–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç —Ç–∏–ø–∞ stars
        const comp = {type:'stars', amount: Math.round(v)};
        if(slots[currentSlotIndex]) inventory.push(slots[currentSlotIndex]);
        slots[currentSlotIndex] = comp;
        renderSlots(); renderInventory(); updateHeader();
        closeModal();
      };
      modalList.appendChild(input);
      modalList.appendChild(addBtn);
    }
  }

  modalSearch.addEventListener('input', () => renderModal());

  // ---------- –ú–∞–≥–∞–∑–∏–Ω –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–≤ ----------
  function renderShop(){
    shopGrid.innerHTML = '';
    shop.forEach((s, idx) => {
      const row = document.createElement('div');
      row.className = 'shop-item';
      const left = document.createElement('div');
      left.innerHTML = `<div style="font-weight:700">${s.name}</div><div class="muted-small">${s.description}</div><div class="muted-small">–í –Ω–∞–ª–∏—á–∏–∏: ${s.qty}</div>`;
      const right = document.createElement('div');
      const priceBadge = `<div style="margin-bottom:6px"><strong>${s.price.toLocaleString('ru-RU')}‚≠ê</strong></div>`;
      const btn = document.createElement('button');
      btn.className='btn';
      btn.textContent = '–ö—É–ø–∏—Ç—å';
      if(s.qty <= 0) { btn.disabled = true; btn.textContent='–ù–µ—Ç'; }
      if(s.cooldownExpire && Date.now() < s.cooldownExpire) {
        btn.disabled = true;
        const remaining = s.cooldownExpire - Date.now();
        btn.textContent = `–†–∞–¥–æ—Å—Ç—É–ø–Ω–æ`;
      }
      btn.onclick = () => {
        if(s.qty <= 0) { alert('–ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏.'); return; }
        if(starBalance < s.price) { alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∑–≤—ë–∑–¥.'); return; }
        if(s.cooldownExpire && Date.now() < s.cooldownExpire){ alert('–≠—Ç–æ—Ç –º–æ–¥ –ø–µ—Ä–µ–∑–∞—Ä—è–∂–∞–µ—Ç—Å—è.'); return; }
        // –í—ã–ø–æ–ª–Ω—è–µ–º –ø–æ–∫—É–ø–∫—É: —Å–ø–∏—Å–∞—Ç—å –∑–≤–µ–∑–¥—ã, –¥–æ–±–∞–≤–∏—Ç—å –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å, —É–º–µ–Ω—å—à–∏—Ç—å qty.
        starBalance -= s.price;
        s.qty -= 1;
        // –¥–æ–±–∞–≤–ª—è–µ–º —ç–∫–∑–µ–º–ø–ª—è—Ä –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∞
        const instance = makeModInstance(s.modId);
        if(instance) inventory.push(instance);
        // –ï—Å–ª–∏ qty == 0, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º cooldown
        if(s.qty <= 0){
          s.cooldownExpire = Date.now() + SHOP_COOLDOWN_MS;
          // —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –∑–∞–ø–∞—Å —á–µ—Ä–µ–∑ cooldown ‚Äî –≤ –¥–µ–º–æ-version –º—ã –Ω–µ —Å–æ–∑–¥–∞—ë–º setTimeout, –ø—Ä–æ—Å—Ç–æ –ø–æ–º–µ—Ç–∏–º
        }
        renderShop();
        renderInventory();
        updateHeader();
      };
      right.appendChild(document.createRange().createContextualFragment(priceBadge));
      right.appendChild(btn);
      row.appendChild(left); row.appendChild(right);
      shopGrid.appendChild(row);
    });
  }

  // ---------- –ö–æ–≤–∫–∞: –ª–æ–≥–∏–∫–∞ ----------
  // –ü—Ä–∏ –∫–æ–≤–∫–µ:
  // - –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—ã–±—Ä–∞–Ω—ã 2..6 –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –∏ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –ø–æ–¥–∞—Ä–æ–∫.
  // - –°–Ω–∏–º–∞–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∏–∑ —Å–ª–æ—Ç–æ–≤ (–æ–Ω–∏ —É–∂–µ –±—ã–ª–∏ —É–¥–∞–ª–µ–Ω—ã –∏–∑ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è –ø—Ä–∏ –≤—ã–±–æ—Ä–µ).
  // - –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—É–º–º–∞—Ä–Ω—É—é "—Å—Ç–æ–∏–º–æ—Å—Ç—å" –≤ –∑–≤—ë–∑–¥–∞—Ö:
  //     - –ø–æ–¥–∞—Ä–∫–∏: ton * TON_TO_STARS
  //     - stars: amount
  //     - –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã: –Ω–µ –¥–æ–±–∞–≤–ª—è—é—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏, –∞ –∏–∑–º–µ–Ω—è—é—Ç –∏—Ç–æ–≥–æ–≤—É—é —Ü–µ–Ω—É (—Å–º. –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã)
  // - –ü—Ä–∏–º–µ–Ω—è–µ–º –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã:
  //     plus10pct => +10% –∫ –∏—Ç–æ–≥–æ–≤–æ–π —Å—Ç–æ–∏–º–æ—Å—Ç–∏
  //     plusminus30 => —Å–ª—É—á–∞–π–Ω–æ +30% –∏–ª–∏ -30% –∫ –∏—Ç–æ–≥–æ–≤–æ–π —Å—Ç–æ–∏–º–æ—Å—Ç–∏
  //     return15pct => 15% —à–∞–Ω—Å –≤–µ—Ä–Ω—É—Ç—å –æ–¥–∏–Ω –∏–∑ –ø–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã—Ö –ø–æ–¥–∞—Ä–∫–æ–≤ –æ–±—Ä–∞—Ç–Ω–æ –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å
  //     saveModifier => –ø–æ—Å–ª–µ –∫–æ–≤–∫–∏ –≤–µ—Ä–Ω—É—Ç—å –æ–¥–∏–Ω —Å–ª—É—á–∞–π–Ω—ã–π –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–π –º–æ–¥ (–∫—Ä–æ–º–µ —Å–µ–±—è)
  // - –†–µ–∑—É–ª—å—Ç–∞—Ç: —Å –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—è–º–∏:
  //     –ø—Ä–æ–≤–∞–ª (–º–∞—Ç–µ—Ä–∏–∞–ª—ã —Ç–µ—Ä—è—é—Ç—Å—è) ‚Äî –Ω–µ–±–æ–ª—å—à–∞—è –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å
  //     —É—Å–ø–µ—Ö —Å –ø–æ–Ω–∏–∂–µ–Ω–∏–µ–º: –∏—Ç–æ–≥=50% –æ—Ç —Å—É–º–º—ã
  //     —É—Å–ø–µ—Ö —Å—Ç–∞–Ω–¥–∞—Ä—Ç: –∏—Ç–æ–≥=rand(65..75)% –æ—Ç —Å—É–º–º—ã
  //     —É—Å–ø–µ—Ö —Å –ø–æ–≤—ã—à–µ–Ω–∏–µ–º: –∏—Ç–æ–≥=175% –æ—Ç —Å—É–º–º—ã
  // - –°–æ–∑–¥–∞—ë—Ç—Å—è –Ω–æ–≤—ã–π –ø–æ–¥–∞—Ä–æ–∫ —Å–æ –∑–Ω–∞—á–µ–Ω–∏–µ–º (TON) = (starsValue / TON_TO_STARS)
  // - –ù–æ–≤—ã–π –ø–æ–¥–∞—Ä–æ–∫ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å (inventory)
  // - –ï—Å–ª–∏ –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –ø–æ —ç—Ñ—Ñ–µ–∫—Ç–∞–º ‚Äî –≤–µ—Ä–Ω—É—Ç—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –º–æ–¥—ã –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å

  function randomChoice(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

  function computeTotalStarsAndExtractUsedMods(components){
    // components ‚Äî –º–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤ (slots content)
    let sumStars = 0;
    const usedMods = [];
    const usedGiftsIndices = []; // to allow returning one if needed
    components.forEach((c, idx) => {
      if(!c) return;
      if(c.type === 'gift'){
        sumStars += Math.round(c.ton * TON_TO_STARS);
      } else if(c.type === 'stars'){
        sumStars += c.amount;
      } else if(c.type === 'mod'){
        usedMods.push(c);
      }
    });
    return {sumStars, usedMods};
  }

  // Apply modifiers to finalStars (returns modified stars and extra effects info)
  function applyModifiers(initialStars, usedMods){
    let stars = initialStars;
    const applied = {
      plus10count:0,
      plusminusResults:[], // + or -
      returnOneGift:false,
      savedModifierReturned:null
    };
    // First handle deterministic ones
    usedMods.forEach(m=>{
      if(m.modId === 'plus10pct'){ stars = Math.round(stars * 1.10); applied.plus10count++; }
    });
    // Then plusminus30
    usedMods.forEach(m=>{
      if(m.modId === 'plusminus30'){
        const up = Math.random() < 0.5;
        if(up){ stars = Math.round(stars * 1.30); applied.plusminusResults.push('+30'); }
        else { stars = Math.round(stars * 0.70); applied.plusminusResults.push('-30'); }
      }
    });
    // return15pct handled later via separate flag: actual return chance will use 15% per such mod
    const returnMods = usedMods.filter(m=>m.modId==='return15pct');
    if(returnMods.length > 0){
      // For each such mod, roll a 15% chance to return one gift (but spec said "—à–∞–Ω—Å 15% –≤–µ—Ä–Ω—É—Ç—å –æ–¥–∏–Ω –∏–∑ –ø–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã—Ö –ø–æ–¥–∞—Ä–∫–æ–≤")
      // We'll aggregate: if any mod triggers, set returnOneGift = true.
      const triggered = returnMods.some(()=>Math.random() < 0.15);
      if(triggered) applied.returnOneGift = true;
    }
    // saveModifier: will return one random used modifier (except saveModifier itself)
    const hasSave = usedMods.some(m=>m.modId === 'saveModifier');
    if(hasSave){
      // choose random used modifier excluding saveModifier
      const candidates = usedMods.filter(m=>m.modId !== 'saveModifier');
      if(candidates.length > 0){
        applied.savedModifierReturned = randomChoice(candidates);
        // we'll actually return it to inventory after forge
      }
    }
    return {stars, applied};
  }

  // Decide outcome: failure or type of success
  function determineOutcome(){
    // We'll use probabilities:
    //   failure: 7%
    //   success-lower (50% of sum): 30%
    //   success-standard (65-75%): 50%
    //   success-high (175%): 13%
    // These add to 100% (7+30+50+13=100)
    const r = Math.random()*100;
    if(r < 7) return {type:'fail'};
    if(r < 7 + 30) return {type:'low'}; // 50%
    if(r < 7 + 30 + 50) return {type:'standard'}; // 65..75
    return {type:'high'}; // 175%
  }

  // Generate a new gift object with approximate TON equivalent
  function createGiftFromStars(starsValue){
    // To make nicer names, choose a gift from giftsList close to the TON value, or create generated name
    // Convert stars back to TON:
    const tonVal = Math.max(0.001, starsValue / TON_TO_STARS);
    // Find nearest gift by ton
    let closest = giftsList[0];
    let bestDiff = Math.abs(closest.ton - tonVal);
    for(const g of giftsList){
      const d = Math.abs(g.ton - tonVal);
      if(d < bestDiff){ bestDiff = d; closest = g; }
    }
    // We'll create a new gift object with name derived (to avoid duplicates)
    // Name like "Forged: <closest.name> (‚âàX TON)" to show it's crafted
    const name = `Forged ${closest.name}`;
    return {type:'gift', name, ton: Number((tonVal).toFixed(4))};
  }

  // Main forge function
  async function doForge(){
    // Collect components
    const components = slots.filter(s=>s !== null);
    if(components.length < 2){
      alert('–ù—É–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –º–∏–Ω–∏–º—É–º 2 –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ (–º–∏–Ω–∏–º—É–º –æ–¥–∏–Ω –ø–æ–¥–∞—Ä–æ–∫).');
      return;
    }
    if(!components.some(c => c.type === 'gift')){
      alert('–•–æ—Ç—è –±—ã –æ–¥–∏–Ω –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–æ–¥–∞—Ä–æ–∫.');
      return;
    }

    // Start animation
    showForgeAnim('–ü–ª–∞–≤–∏–º –º–∞—Ç–µ—Ä–∏–∞–ª—ã...');

    // Compute base stars and used mods
    const {sumStars, usedMods} = computeTotalStarsAndExtractUsedMods(components);

    // We will remove components from slots ‚Äî they are consumed if not returned
    // For now, make a copy of used components to potentially return later
    const consumedComponents = [...slots];
    // Clear slots immediately to reflect consumption
    slots = [null,null,null,null,null,null];
    renderSlots();

    // Wait FORGE_DURATION_MS
    await new Promise(r => setTimeout(r, FORGE_DURATION_MS));

    // Determine outcome
    const outcome = determineOutcome();
    let finalStars = 0;
    let appliedInfo = null;
    if(outcome.type === 'fail'){
      // Materials lost
      finalStars = 0;
      appliedInfo = {outcome:'fail'};
    } else {
      // Start with base sum
      let base = sumStars;
      // Apply outcome multipliers
      if(outcome.type === 'low') {
        base = Math.round(base * 0.50); // 50% of sum
      } else if(outcome.type === 'standard') {
        const p = 65 + Math.random()*10; // 65..75
        base = Math.round(base * (p/100));
      } else if(outcome.type === 'high'){
        base = Math.round(base * 1.75); // +75%
      }
      // Apply modifiers
      const modRes = applyModifiers(base, usedMods);
      finalStars = modRes.stars;
      appliedInfo = {outcome: outcome.type, modsApplied: modRes.applied};
    }

    // Handle return of one placed gift if modifier triggered
    if(appliedInfo && appliedInfo.modsApplied && appliedInfo.modsApplied.returnOneGift){
      // find a gift among consumedComponents and return one randomly to inventory
      const giftsPlaced = consumedComponents.filter(c => c && c.type === 'gift');
      if(giftsPlaced.length > 0){
        const toReturn = randomChoice(giftsPlaced);
        inventory.push(toReturn);
        // Remove one occurrence from consumedComponents so it's not double-used (not strictly necessary here)
        const idx = consumedComponents.indexOf(toReturn);
        if(idx > -1) consumedComponents.splice(idx,1);
        // Inform user
      }
    }

    // Handle saveModifier returning random used modifier (except saveModifier itself)
    if(appliedInfo && appliedInfo.modsApplied && appliedInfo.modsApplied.savedModifierReturned){
      // Return that specific modifier instance (we assume instances were in usedMods, we need to re-add one instance)
      inventory.push({...appliedInfo.modsApplied.savedModifierReturned, type:'mod'});
    }

    // If success (finalStars>0), create new gift accordingly
    if(finalStars > 0){
      // Create gift
      const newGift = createGiftFromStars(finalStars);
      inventory.push(newGift);
      forgeResult.innerHTML = `<div style="color:var(--success)">‚úÖ –£—Å–ø–µ—Ö! –ü–æ–ª—É—á–µ–Ω –Ω–æ–≤—ã–π –ø–æ–¥–∞—Ä–æ–∫ <strong>${newGift.name}</strong> ‚Äî ‚âà <strong>${Math.round(newGift.ton*TON_TO_STARS)}‚≠ê</strong> (–æ—Å–Ω–æ–≤–∞–Ω–æ –Ω–∞ ${finalStars}‚≠ê)</div>`;
    } else {
      forgeResult.innerHTML = `<div style="color:var(--danger)">üí• –ù–µ—É–¥–∞—á–∞ ‚Äî –º–∞—Ç–µ—Ä–∏–∞–ª—ã —Å–≥–æ—Ä–µ–ª–∏ –∏ –Ω–∏—á–µ–≥–æ –Ω–µ —Å–æ–∑–¥–∞–Ω–æ.</div>`;
    }

    // Any used modifiers/consumed items (except those returned above) are already removed from slots and not re-added.
    // Update inventory and header
    renderInventory();
    renderSlots();

    // hide animation
    hideForgeAnim();
  }

  // ---------- Forge animation UI ----------
  function showForgeAnim(text){
    forgeOverlay.classList.add('show');
    document.getElementById('forgeAnimText').textContent = text;
    // create some sparks
    sparksContainer.innerHTML = '';
    for(let i=0;i<10;i++){
      const s = document.createElement('div');
      s.className = 'spark';
      s.style.left = (10 + Math.random()*80) + '%';
      s.style.animationDelay = (Math.random()*400) + 'ms';
      s.style.background = Math.random() < 0.5 ? 'var(--accent)' : 'rgba(255,123,0,0.6)';
      sparksContainer.appendChild(s);
    }
  }
  function hideForgeAnim(){
    forgeOverlay.classList.remove('show');
    sparksContainer.innerHTML = '';
  }

  // ---------- –°–æ–±—ã—Ç–∏—è –∫–Ω–æ–ø–æ–∫ ----------
  forgeBtn.onclick = async () => {
    // Guard to prevent double-click
    forgeBtn.disabled = true;
    await doForge();
    forgeBtn.disabled = false;
  };
  clearBtn.onclick = () => {
    // –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –≤—Å–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –≤ —Å–ª–æ—Ç—ã –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å
    for(let i=0;i<6;i++){
      if(slots[i]) inventory.push(slots[i]);
      slots[i] = null;
    }
    renderSlots();
    renderInventory();
    forgeResult.textContent = '–°–ª–æ—Ç—ã –æ—á–∏—â–µ–Ω—ã.';
  };
  autoFillBtn.onclick = () => {
    autofillSlotsForTest();
    forgeResult.textContent = '–°–ª–æ—Ç—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω—ã (—Ç–µ—Å—Ç).';
  };

  // ---------- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è UI ----------
  async function initUI(){
    // –°–æ–∑–¥–∞—Ç—å 6 –ø—É—Å—Ç—ã—Ö –∫–∞—Ä—Ç–æ—á–µ–∫
    for(let i=0;i<6;i++){
      const placeholder = document.createElement('div');
      placeholder.className='card';
      placeholder.innerHTML = '<div style="font-size:26px;color:var(--accent)">+</div>';
      cardsGrid.appendChild(placeholder);
    }
    updateHeader();
    await renderInventory();
    await renderSlots();
    renderShop();
  }

  // ---------- Event: –º–∞–≥–∞–∑–∏–Ω –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç –¥–æ—Å—Ç—É–ø (–≤ –¥–µ–º–æ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–∞–π–º–µ—Ä —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è) ----------
  setInterval(() => {
    // –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º shop (–Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ–∫–æ–Ω—á–∞–Ω–∏—è cooldown)
    renderShop();
  }, 10000);

  // ---------- Start ----------
  initUI();

  // –£–ª—É—á—à–µ–Ω–∏–µ UX: –∑–∞–∫—Ä—ã–≤–∞—Ç—å –º–æ–¥–∞–ª –ø–æ esc
  document.addEventListener('keydown', (e)=>{
    if(e.key === 'Escape') closeModal();
  });

  // –ù–µ–º–Ω–æ–≥–æ –ø–æ—è—Å–Ω–µ–Ω–∏–π –æ –ø–æ–≤–µ–¥–µ–Ω–∏–∏ (–ø–æ–∫–∞–∂–µ–º –≤ –∫–æ–Ω—Å–æ–ª–∏)
  console.log('Gifts Forge demo loaded. –í—Å–µ –¥–∞–Ω–Ω—ã–µ ‚Äî –≤ –ø–∞–º—è—Ç–∏, –±–µ–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è.');
  </script>
</body>
</html>
